var GameView=function(e){function t(){e.call(this),this._gridLvArr=[2,3,3,4,4,5,5,6,6,7,7,7,8,8,8,8,8,9],this._gridTypeArr=[1,2,3,4,5,6,7,8,9,10,11,12,13,14],this._scoreLvDes=["无药可救","重度脸盲","中度脸盲","轻度脸盲","顿足捶胸","手疾眼快","火眼金睛"],this._scoreLv=[21,31,41,51,56,60],this._score=0,this._totalTime=3e4,this._runTime=0,this._currentLv=0,this._zxh=new egret.Bitmap,this.__title="测测你有脸盲症吗！",this.__desc="你以为你躲起来就找不到你了吗，没有用的！",this.__iconLink="http://egret-game.b0.upaiyun.com/icons/10000007.jpg",this._space=13.5,this._row=3,this._line=3,this._shareView=new egret.Sprite,this._shareLabel=new egret.gui.Label,this._shareTip=new egret.Bitmap,this._shareTipLabel=new egret.gui.Label}__extends(t,e);var i=(__define,t),s=i.prototype;return s.createGame=function(e){var t=new Logo("Powered by Egret FrameWork",20,0);t.x=110,t.y=635,this.addChild(t);var i=this;RES.getResByUrl("resource/assets/fx1.png",function(e){i._shareImgtDown=e},this),RES.getResByUrl("resource/assets/fx2.png",function(e){i._shareImgtUp=e},this),RES.getResByUrl("resource/assets/shareTip.png",function(e){this._shareTip.texture=e},this),ShareUtils.setShareInfo(this.__title,this.__desc,this.__iconLink),this._res=e,this._startBtn=new ImgBtn,this._startBtn.x=85,this._startBtn.y=385,this._startBtn.createBtn(this._res.getTexture("start1"),this._res.getTexture("start2"),this),this._startBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.firstStartGame,this),this._zxh.texture=this._res.getTexture("zxh"),this._restartBtn=new ImgBtn,this._restartBtn.createBtn(this._res.getTexture("restart1"),this._res.getTexture("restart2"),this),this._restartBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.restartGame,this),this._restartBtn.x=85,this._restartBtn.y=385,this._moreBtn=new ImgBtn,this._moreBtn.createBtn(this._res.getTexture("more1"),this._res.getTexture("more2"),this),this._moreBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.more,this),this._moreBtn.x=85,this._moreBtn.y=500,this._gameDesLable1=new egret.gui.Label,this._gameDesLable1.text="茫茫人海中",this._gameDesLable1.x=175,this._gameDesLable1.y=70,this._gameDesLable2=new egret.gui.Label,this._gameDesLable2.text="你的小伙伴在哪里？",this._gameDesLable2.x=126,this._gameDesLable2.y=120,this._lvDesLable=new egret.gui.Label,this._lvDesLable.text="",this._lvDesLable.size=30,this._lvDesLable.x=20,this._lvDesLable.y=320,this._scoreLaber=new egret.gui.Label,this._scoreLaber.text="得分："+this._score.toString(),this._scoreLaber.x=30,this._scoreLaber.y=35,this._timeLabel=new egret.gui.Label,this._timeLabel.x=220,this._timeLabel.y=35,this._timeLabel.text="60",this._gridContainer=new egret.Sprite,this._gridContainer.y=140,this._gridContainer.x=0,this._gridContainer.width=480,this._gridContainer.height=480,this._gridContainer.graphics.beginFill(16777215),this._gridContainer.graphics.drawRect(0,0,this._gridContainer.width,this._gridContainer.height),this._gridContainer.graphics.endFill(),this.initGameStartView(),this.initGridPool()},s.initGameStartView=function(){this.addChild(this._gameDesLable1),this.addChild(this._gameDesLable2),this.addChild(this._startBtn),this.addChild(this._moreBtn),this._zxh.x=195,this._zxh.y=200,this.addChild(this._zxh)},s.initGridPool=function(){this._gridPool=[];for(var e=0;81>e;e++){var t=new Grid;this._gridPool.push(t)}},s.firstStartGame=function(e){this.removeChild(this._gameDesLable1),this.removeChild(this._gameDesLable2),this.removeChild(this._startBtn),this.removeChild(this._zxh),this.removeChild(this._moreBtn),this.startGame()},s.startGame=function(){this.addChild(this._scoreLaber),this.addChild(this._timeLabel),this.addChild(this._gridContainer),this.createGrids(this.getGridLv(this._currentLv)),egret.Ticker.getInstance().register(this.loop,this)},s.getGridLv=function(e){return e>this._gridLvArr.length-1?9:this._gridLvArr[e]},s.createGrids=function(e){this.destroyGrids(),this._row=e,this._line=e,this._size=(this.width-(e+1)*this._space)/e;for(var t=this.getDifTypeAndPos(e),i=0;i<this._row;i++)for(var s=0;s<this._line;s++){var r=this._row*i+s+1;if(r==t[2])var h=this.getGrid(r,t[1],s,i,!0);else var h=this.getGrid(r,t[0],s,i);this._gridContainer.addChild(h),h.addEventListener(egret.TouchEvent.TOUCH_TAP,this.gridTouchTapHandler,this)}},s.destroyGrids=function(){for(;this._gridContainer.numChildren;)this._gridPool.push(this._gridContainer.removeChildAt(0))},s.gridTouchTapHandler=function(e){console.log(e.target),e.target._index==this._difPos&&(this._currentLv++,this._score++,this._scoreLaber.text="得分："+this._score.toString(),this.nextGirdLv())},s.nextGirdLv=function(){this.createGrids(this.getGridLv(this._currentLv))},s.getDifTypeAndPos=function(e){var t=this._gridTypeArr.length,i=Math.floor(Math.random()*t+1),s=Math.floor(Math.random()*t+1);i==s&&(s=1==i?2:i-1);var r=Math.floor(Math.random()*e*e+1);return this._difPos=r,[i,s,r]},s.getGrid=function(e,t,i,s,r){var h=this._gridPool.shift(),a=t.toString(),n=this._res.getTexture(a);h.width=this._size,h.height=this._size;var o=this._size/142;return h.x=(i+1)*this._space+i*this._size,h.y=(s+1)*this._space+s*this._size,h._dispatcher=this,h.reset(e,t,n,o),h},s.loop=function(e){this._runTime=this._runTime+e,this._runTime>this._totalTime&&(egret.Ticker.getInstance().unregister(this.loop,this),this.gameOver());var t=Math.floor((this._totalTime-this._runTime)/1e3);this._timeLabel.text=t.toString()},s.gameOver=function(){this.getLvDesByScore(this._score),this.initGameOverView()},s.getLvDesByScore=function(e){this.__num=Math.floor(7*Math.random()),this._lvDesLable.text="我闯过了"+e+"关，被认定为"+this._scoreLvDes[this.__num]},s.initGameOverView=function(){this._shareGameBtn=new ImgBtn,this._shareGameBtn.createBtn(this._shareImgtUp,this._shareImgtDown,this),this._shareGameBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.shareGame,this),this._shareGameBtn.x=85,this._shareGameBtn.y=500,this.removeChild(this._timeLabel),this.removeChild(this._scoreLaber),this.removeChild(this._gridContainer),this._zxh.x=195,this._zxh.y=120,this.addChild(this._zxh),this.addChild(this._lvDesLable),this.addChild(this._restartBtn),this.addChild(this._shareGameBtn),this.__title="测测你有脸盲症吗！",this.__desc="我闯过了"+this._score+"关，被认定为"+this._scoreLvDes[this.__num]+"，不服来试试！",ShareUtils.setShareInfo(this.__title,this.__desc,this.__iconLink)},s.restartGame=function(e){this._shareView.parent&&this.removeChild(this._shareView),this._runTime=0,this._score=0,this._currentLv=0,this._scoreLaber.text="得分：0",this._timeLabel.text="60",this.removeChild(this._lvDesLable),this.removeChild(this._zxh),this.removeChild(this._restartBtn),this.removeChild(this._shareGameBtn),this.startGame()},s.showShareView=function(){this._shareView.width=this.stage.stageWidth,this._shareView.height=this.stage.stageHeight,this._shareView.graphics.clear(),this._shareView.graphics.beginFill(5592405,.5),this._shareView.graphics.drawRect(0,0,this._shareView.width,this._shareView.height),this._shareView.graphics.endFill(),this._shareView.touchEnabled=!0,this._shareTip.x=this._shareView.width-150,this._shareTip.y=0,this._shareView.addChild(this._shareTip),this._shareTipLabel.text="分享到朋友圈",this._shareTipLabel.y=60,this._shareTipLabel.x=200,this._shareTipLabel.size=25,this._shareView.addChild(this._shareTipLabel),this._shareView.addChild(this._lvDesLable),this.addChild(this._shareView),this.__title="测测你有脸盲症吗！",this.__desc="我闯过了"+this._score+"关，被认定为"+this._scoreLvDes[this.__num]+"，不服来试试！",ShareUtils.shareToWeChat(),this._shareView.addEventListener(egret.TouchEvent.TOUCH_TAP,this.removeShareView,this)},s.shareGame=function(e){ShareUtils.isInWeChat()?this.showShareView():ShareUtils.shareToU9()},s.removeShareView=function(e){this._shareView.parent&&this.removeChild(this._shareView),this.addChild(this._lvDesLable)},s.more=function(){ShareUtils.moreGame()},t}(egret.DisplayObjectContainer);egret.registerClass(GameView,"GameView");var Grid=function(e){function t(){e.call(this),this._index=0,this._type=0,this._imgIco=new egret.Bitmap,this.touchEnabled=!0,this.addChild(this._imgIco)}__extends(t,e);var i=(__define,t),s=i.prototype;return s.touchTapHandler=function(e){this._dispatcher.dispatchEventWith("GridTouchTap",!0)},s.reset=function(e,t,i,s){this._imgIco.texture=i,this._imgIco.scaleX=s,this._imgIco.scaleY=s,this._index=e,this._type=t},t}(egret.DisplayObjectContainer);egret.registerClass(Grid,"Grid");var ImgBtn=function(e){function t(){e.call(this)}__extends(t,e);var i=(__define,t),s=i.prototype;return s.createBtn=function(e,t,i){this._downImg=new egret.Bitmap,this._upImg=new egret.Bitmap,this._downImg.texture=t,this._upImg.texture=e,this.touchEnabled=!0,this._dispatcher=i,this.addChild(this._downImg),this.addChild(this._upImg),this.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.downHandler,this),this.addEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,this.upHandler,this),this.addEventListener(egret.TouchEvent.TOUCH_END,this.upHandler,this)},s.downHandler=function(e){this._downImg.visible=!0,this._upImg.visible=!1},s.upHandler=function(e){this._downImg.visible=!1,this._upImg.visible=!0},s.touchTapHandler=function(e){this._dispatcher.dispatchEventWith("startGame")},t}(egret.Sprite);egret.registerClass(ImgBtn,"ImgBtn");var LoadingUI=function(e){function t(){e.call(this),this.logoUrl="resource/assets/loading_logo.png",this.bgUrl="resource/assets/loading_bg.jpg",this.createView()}__extends(t,e);var i=(__define,t),s=i.prototype;return s.createView=function(){this.w=480,egret.MainContext.instance.stage.scaleMode==egret.StageScaleMode.NO_BORDER?this.h=document.documentElement.clientHeight*(480/document.documentElement.clientWidth):this.h=800,this.textField=new egret.TextField,this.textField.y=500,this.textField.textColor=3355443,this.textField.size=23,this.textField.width=this.w,this.textField.height=100,this.textField.fontFamily="Black",this.textField.textAlign="center",this.textField_power=new egret.TextField,this.textField_power.y=.9*this.h,this.textField_power.textColor=3355443,this.textField_power.width=this.w,this.textField_power.height=100,this.textField_power.size=20,this.textField_power.text="Powered by Egret Engine",this.textField_power.fontFamily="Black",this.textField_power.textAlign="center";var e=new egret.URLLoader;e.addEventListener(egret.Event.COMPLETE,this.onComplete,this),e.dataFormat=egret.URLLoaderDataFormat.TEXTURE,e.load(new egret.URLRequest(this.logoUrl));var e=new egret.URLLoader;e.addEventListener(egret.Event.COMPLETE,this.onComplete,this),e.dataFormat=egret.URLLoaderDataFormat.TEXTURE,e.load(new egret.URLRequest(this.bgUrl)),this.bg=new egret.Bitmap,this.logo=new egret.Bitmap,this.uiContainer=new egret.DisplayObjectContainer,this.addChild(this.uiContainer),this.addChild(this.logo),this.addChildAt(this.bg,0),this.addChild(this.textField),this.addChild(this.textField_power)},s.onComplete=function(e){var t=e.target,i=t.data;t._request.url==this.bgUrl?(this.bg.texture=i,this.bg.scaleX=this.w/640,this.bg.scaleY=this.h/960):t._request.url==this.logoUrl&&(this.logo.texture=i,this.logo.anchorOffsetX=.5*this.logo.width,this.logo.anchorOffsetY=.5*this.logo.height,this.logo.x=this.w/2,this.logo.y=this.h/2-60,this.logo.scaleX=this.logo.scaleY=this.h/960,this.textField.y=this.logo.y+100)},s.setProgress=function(e,t){var i=Math.floor(e/t*100);this.textField.text="游戏加载中�??"+i+"%"},s.onLoadComplete=function(e,t){},t}(egret.Sprite);egret.registerClass(LoadingUI,"LoadingUI");var Logo=function(e){function t(t,i,s){e.call(this);var r=new egret.gui.Label;r.text=t,r.size=i,r.textColor=s,this.addChild(r)}__extends(t,e);var i=(__define,t);i.prototype;return t}(egret.Sprite);egret.registerClass(Logo,"Logo");var Main=function(e){function t(){e.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.addToStage,this),ShareUtils.onEnterGame()}__extends(t,e);var i=(__define,t),s=i.prototype;return s.addToStage=function(e){this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},s.onConfigComplete=function(e){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.loadGroup("preload")},s.onResourceLoadComplete=function(e){"preload"==e.groupName&&(RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),this.stage.removeChild(this.loadingView),this.createGameScene())},s.onResourceProgress=function(e){"preload"==e.groupName&&this.loadingView.setProgress(e.itemsLoaded,e.itemsTotal)},s.createGameScene=function(){console.log(RES.getRes("sprites_json")),this._res=RES.getRes("sprites_json");var e=new egret.Bitmap;e.texture=this._res.getTexture("bg"),this.addChild(e),this.initGame()},s.initGame=function(){this._gameView=new GameView,this._gameView._res=this._res,this._gameView.width=this.stage.stageWidth,this._gameView.height=this.stage.stageHeight,this._gameView.createGame(this._res),this.addChild(this._gameView)},t}(egret.DisplayObjectContainer);egret.registerClass(Main,"Main");var ShareUtils=function(){function e(){}var t=(__define,e);t.prototype;return e.moreGame=function(){},e.shareToWeChat=function(){},e.shareToU9=function(){var t=location.href;t+=""==location.search?"?channel=weixin":"&channel=weixin",t=encodeURIComponent(t);var i="123",s=encodeURIComponent(e.shareDesc),r=e.getUid(),h="u9time://share?uid="+r+"&game_url="+t+"&a="+i+"&msg="+s;r||(h="u9time://share?&game_url="+t+"&a="+i+"&msg="+s),location.href=h},e.setShareInfo=function(t,i,s){e.shareTitle=t,e.shareDesc=i,e.shareImgUrl=s,e.shareToWeChat()},e.isInWeChat=function(){var e=window.navigator.userAgent;return-1!=e.indexOf("MicroMessenger")},e.isInU9=function(){var e=window.navigator.userAgent;return-1!=e.indexOf("EgretRuntime")&&-1!=e.indexOf("yoyo")},e.findLocationProperty=function(e){if(this.hasOwnProperty("location")){var t=location.search;if(""==t)return null;t=t.slice(1);for(var i=t.split("&"),s=i.length,r=0;s>r;r++){var h=i[r],a=h.split("=");if(a[0]==e)return a[1]}}return null},e.getUid=function(){return e.findLocationProperty("uid")},e.onEnterGame=function(){var t=e.findLocationProperty("app_id"),i=e.findLocationProperty("game_id"),s=e.findLocationProperty("device_id");if(t&&i){s||(s=egret.localStorage.getItem("device_id"),s||(s=Math.random())),egret.localStorage.setItem("device_id",s);var r="http://statistics.egret-labs.org/api.php?app_id="+t+"&game_id="+i+"&device_id="+s,h=e.findLocationProperty("channel");if(h&&e.isInWeChat()&&(r+="&channel="+h),r){var a=new egret.URLLoader;a.load(new egret.URLRequest(r))}}},e}();egret.registerClass(ShareUtils,"ShareUtils");